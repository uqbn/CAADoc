<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="Stylesheet" type="text/css" href="../CAADocStyleSheets/caav5.css">
<title>Managing (User Defined) Features for Macro Motions</title>
</head>

<body>

<table width="100%">
  <tr>
    <td valign="top">
      <h1>Machining</h1>
    </td>
    <td valign="top">
      <h2>All Machining Workbenches</h2>
    </td>
    <td rowspan="2" align="right" valign="top">
      <h3><a name="Top"></a>Managing (User Defined) Features for Macro Motions</h3>
      <em>Implementing the </em><i>CATIMfgMacroMotionsGeomMapping</i> <em>interface</em></td>
  </tr>
  <tr>
    <td class="use" colspan="2">Use Case</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->

<table class="abstract">
  <tr>
    <td>
      <h3>Abstract</h3>
      <p>This article discusses the CAAMaiUdfForGeomMacroMotions use case and
      explains how to implement the <i>CATIMfgMacroMotionsGeomMapping</i>
      manufacturing interface.</p>
      <ul>
        <li><a href="#Learn"><strong>What You Will Learn With This Use Case</strong></a></li>
        <li><strong><a href="#UseCase">The <u>CAAMaiUdfForGeomMacroMotions U</u>se
          Case</a></strong>
          <ul>
            <li><a href="#What">What Does CAAMaiUdfForGeomMacroMotions Do</a></li>
            <li><a href="#How">How to Use CAAMaiUdfForGeomMacroMotions</a></li>
            <li><a href="#Where">Where to Find the CAAMaiUdfForGeomMacroMotions
              Code</a></li>
          </ul>
        <li><a href="#Step"><strong>Step-by-Step</strong></a></li>
        <li><b><a href="#InShort">In Short</a></b></li>
        <li><b><a href="#References">References</a></b></li>
      </ul>
    </td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="Learn"></a>What You Will Learn With This Use Case</h3>
<p>This use case is intended to help you apply an axial operation from a User
Defined Feature, by implementing the <i>CATIMfgMacroMotionsGeomMapping</i>
manufacturing interface. This involves the following:</p>
<ul>
  <li>Overviewing the User Defined Features functionality in a manufacturing
    context</li>
  <li>Implementing all the methods of <i>CATIMfgMacroMotionsGeomMapping</i> to
    solve geometrical macro motions by using &quot;<i>CATIUdfFeatureInstance</i>&quot;
    and &quot;<i>CATIUdfFeatureUser</i>&quot; User Features CAA interfaces and
    the &quot;<i>CATIMfgMappingRuleName</i>&quot; Machining CAA interface</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h3><a name="UseCase"></a>The CAAMaiUdfForGeomMacroMotions Use Case</h3>
<p>CAAMaiUdfForGeomMacroMotions is a use case of the CAAManufacturingItf.edu
framework in the CAAMaiUserDefFeatureMapping.m module that illustrates
ManufacturingInterfaces framework capabilities.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="What"></a>What Does CAAMaiUdfForGeomMacroMotions Do</h4>
<p>CAAMaiUdfForGeomMacroMotions illustrates an implementation of
CATIMfgMacroMotionsGeomMapping interface for the User Defined Features
identified by the UdfFeature type. This implementation enables to assign
geometry like planes or points to macro motions defined in the Machining
Process. A such implementation can be done to any feature that is used as input
of the Machining Process instantiation window.</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->
<h4><a name="How"></a>How to Use CAAMaiUdfForGeomMacroMotions</h4>
<p>To use CAAMaiUdfForGeomMacroMotions, you will need to:</p>
<ul>
  <li>Set up the build time environment, then compile
    CAAMaiUserDefFeatureMapping.m module along with its prerequisites [<a href="#References">1</a>]</li>
  <li>Edit the interface dictionary, that is, the CAAManufacturingItf.edu.dico
    file located in:
    <table width="100%">
      <tr>
        <td>Windows</td>
        <td><code>InstallRootDirectory\CAADoc\CAAManufacturingItf.edu\CNext\code\dictionary\</code></td>
      </tr>
      <tr>
        <td>Unix</td>
        <td><code>InstallRootDirectory/CAADoc/CAAManufacturingItf.edu/CNext/code/dictionary/</code></td>
      </tr>
    </table>
    <p>where <code>InstallRootDirectory</code> is the directory where the CAA
    CD-ROM is installed, and decomment the following line by removing the '#'
    character:</p>
    <pre>UdfFeature CATIMfgMacroMotionsGeomMapping libCAAMaiUserDefFeatureMapping</pre>
  </li>
  <li>Set up the run time environment</li>
  <li>Launch a CATIA V5 session</li>
  <li>Open the CAAMaiMachiningProcessForUdfWithNCMacroData.CATProcess file located in:
    <table width="100%">
      <tr>
        <td>Windows</td>
        <td><code>InstallRootDirectory\CAADoc\CAAManufacturingItf.edu\CNext\resources\graphic\</code></td>
      </tr>
      <tr>
        <td>Unix</td>
        <td><code>InstallRootDirectory/CAADoc/CAAManufacturingItf.edu/CNext/resources/graphic/</code></td>
      </tr>
    </table>
  </li>
  <li>Apply a machining process with geometrical macro motions</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Where"></a>Where to Find the CAAMaiUdfForGeomMacroMotions Code</h4>
<p>The CAAMaiUdfForGeomMacroMotions use case is made of a class named <i>CAAMaiUdfForGeomMacroMotion</i>
located in the CAAMaiUserDefFeatureMapping.m module of the
CAAManufacturingItf.edu framework:</p>
<table width="100%">
  <tr>
    <td>Windows</td>
    <td><code>InstallRootDirectory\CAADoc\CAAManufacturingItf.edu\</code><code>CAAMaiUserDefFeatureMapping.m</code></td>
  </tr>
  <tr>
    <td>Unix</td>
    <td><code>InstallRootDirectory/CAADoc/CAAManufacturingItf.edu/</code><code>CAAMaiUserDefFeatureMapping.m</code></td>
  </tr>
</table>
<p>where <code>InstallRootDirectory</code> is the directory where the CAA CD-ROM
is installed.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step"></a>Step-by-Step</h4>
<p>There are three logical steps in CAAMaiUdfForGeomMacroMotions:</p>
<ol>
  <li><a href="#Step1">Implementing the CATIMfgMacroMotionsGeomMapping Interface
    for UdfFeature Types</a></li>
  <li><a href="#Step2">Creating a User Defined Feature Template and Generating
    Instances</a></li>
  <li><a href="#Step3">Applying the
    &quot;MachiningProcessUsingMacroMotionMapping&quot; Machining Process on a
    User Defined Feature Instance</a></li>
</ol>
<p>We now comment each of those sections by looking at the code.</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step1"></a>Implementing the CATIMfgMacroMotionsGeomMapping
Interface for UdfFeature Types</h4>
<p style="margin-left: 4">The CAAMaiUdfForGeomMacroMotions.cpp file uses the
&quot;CATIUdfFeatureInstance&quot; interface to access to the User Defined
Feature information - then, the right data is accessed by its right role name -
and the &quot;CATIMfgMappingRuleName&quot; interface to access to &quot;mapping
rule name&quot; tag which defines the using context of the feature . See below a
part of the implementation:</p>
<p style="margin-left: 4">This part of code enables to access to the
&quot;mapping rule name&quot; defined in the operation of machining process</p>
<table class="code" height="238">
  <tr>
    <td height="234">
      <pre style="margin-top: 0">...
//----------------------------------------------------------------------
// Read the mapping rule name associated to the operation 
//----------------------------------------------------------------------
CATUnicodeString MappingRuleName = &quot;&quot;;
<b>CATIMfgMappingRuleName</b> *piMappRuleName = NULL;
RetCode = this-&gt;QueryInterface(IID_CATIMfgMappingRuleName,(void **)&amp;piMappRuleName);
if (SUCCEEDED(RetCode) &amp;&amp; NULL != piMappRuleName) 
{
 MappingRuleName = piMappRuleName-&gt;GetMappingRuleName();
 piMappRuleName-&gt;Release();
 piMappRuleName = NULL;
}
...</pre>
    </td>
  </tr>
</table>
<p style="margin-left: 4; margin-top: 0">Then, when executing Catia, the value
of the MappingRuleName variable can be &quot;AxialUdfWithMacroMap&quot;
corresponding to the Machining Process definition (see the
CAAMaiMachiningProcessForUdfWithNCMacroData.CATProcess file in the above
directory):<img border="0" src="images/CAAMaiMPMappingRuleName1.gif" width="557" height="400">&nbsp;&nbsp;
<img border="0" src="images/CAAMaiMPMappingRuleName2.gif" width="177" height="90"></p>
<p>&nbsp;According to this variable, the implementation is looking for the right
User Feature geometry:</p>
<table class="code">
  <tr>
    <td>
      <pre style="margin-top: 0; margin-bottom:0">...
//--------------------------------------------------------------------------
// Number of macro motions to be solved
//--------------------------------------------------------------------------
int NbOfMotions = iElementaryMotionTypeList.Size();

for (int numMotion = 1; numMotion &lt;= NbOfMotions &amp;&amp; SUCCEEDED(RetCode); numMotion++)
{
  // &quot;Go to a plane&quot; motion case
  if (6 == iElementaryMotionTypeList[numMotion])
  {
    CATUnicodeString GeometryName;
    if (1 == iMacroMotionType || 2 == iMacroMotionType)
    {
     if (MappingRuleName == &quot;<b>AxialUdfWithMacroMap</b>&quot;)</pre>
      <pre style="margin-top: 0; margin-bottom:0">     {
      if (iActivityType == &quot;ProfileContouring&quot;)
      {
       if (1 == numMotion)
        GeometryName = &quot;Lower_Plane&quot;;
       else
        GeometryName = &quot;Security_Plane&quot;;
      }
      else
       GeometryName = &quot;Security_Plane&quot;;</pre>
      <pre style="margin-top: 0; margin-bottom:0">     }
     else 
      GeometryName = &quot;SecurityPlane&quot;;
    }
    else
    {
     if (MappingRuleName == &quot;AxialUdfWithMacroMap&quot;)
      GeometryName = &quot;Lower_Plane&quot;;
     else 
     {
      GeometryName = &quot;Drive&quot;;
      if (MappingRuleName == &quot;Upper_Drive_Rule&quot;)
       GeometryName = &quot;Upper_Drive&quot;;
      else if (MappingRuleName == &quot;Lower_Drive_Rule&quot;)
       GeometryName = &quot;Lower_Drive&quot;;
     }
    }
  }
  CATBaseUnknown_var Geometry;
  if (SUCCEEDED(RetCode))
  {
    CATBaseUnknown *piUdf = NULL;
    RetCode = this-&gt;QueryInterface(IID_CATBaseUnknown,(void **)&amp;piUdf);
    if (SUCCEEDED(RetCode) &amp;&amp; NULL != piUdf) 
    {
     RetCode = CAAMaiUdfUtilities::GetUdfGeometry (piUdf, GeometryName, Geometry);
     piUdf-&gt;Release();
     piUdf = NULL;
    }
  }

  if (SUCCEEDED(RetCode))
  {
    CATISketch_var Sketch(Geometry);
    if (NULL_var != Sketch) 
    {
      CATISpecObject_var oPlane;
      RetCode = Sketch-&gt;GetPlanarSupport(oPlane);
      if (SUCCEEDED(RetCode))
      {
        CATBaseUnknown_var MacroPlane(oPlane);
        oGeometryList.Append(MacroPlane);
      }
      else 
        RetCode = E_FAIL;
    }
    else
      oGeometryList.Append(Geometry);
   }
 }
  // &quot;Go to a point&quot; motion case
  else if (7 == iElementaryMotionTypeList[numMotion])
  {
    CATUnicodeString GeometryName;
    if (iActivityType == &quot;Drilling&quot;) 
      GeometryName = &quot;Drilling_Point&quot;;
    else
      GeometryName = &quot;HomePoint&quot;;

    CATBaseUnknown_var Geometry;
    RetCode = GetUdfGeometry (GeometryName, Geometry);
    if (SUCCEEDED(RetCode))
      oGeometryList.Append(Geometry);
  }
  // non supported case
  else
    RetCode = E_FAIL;
}
...</pre>
      <pre style="margin-top: 0">// Generic method to get a User Feature geometry from its role name</pre>
      <pre style="margin-top: 0; margin-bottom:0">HRESULT CAAMaiUdfUtilities::GetUdfGeometry (CATBaseUnknown * iUdf, </pre>
      <pre style="margin-top: 0; margin-bottom:0">        CATUnicodeString iGeometryName, CATBaseUnknown_var &amp;oGeometry)
{
 oGeometry = NULL_var;</pre>
      <pre style="margin-top: 0; margin-bottom:0"> HRESULT RC = E_FAIL;
 if (NULL == iUdf) return RC;

 //--------------------------------------------------------------------------
 // Get your object as a CATIUdfFeatureInstance
 //--------------------------------------------------------------------------
 CATIUdfFeatureInstance *piUdfFeatureInstance = NULL;
 RC = iUdf-&gt;QueryInterface(IID_CATIUdfFeatureInstance,(void **)&amp;piUdfFeatureInstance);
 //--------------------------------------------------------------------------
 // Your object is a CATIUdfFeatureInstance: we can use the associated methods
 //--------------------------------------------------------------------------
 if (SUCCEEDED(RC) &amp;&amp; NULL != piUdfFeatureInstance)
 { 
  CATUnicodeString role = &quot;&quot;;
  CATBaseUnknown_var spGeom;
 
  //----------------------------------------------------------------------
  // Read the Inputs number: this is the geometrical inputs of your Udf
  // defined when creating the Udf template
  //----------------------------------------------------------------------
  int InputNb = 0;
  RC = piUdfFeatureInstance-&gt;GetInputsNumber(InputNb);

  int i = 1;
  while (SUCCEEDED(RC) &amp;&amp; i &lt;= InputNb &amp;&amp; role != iGeometryName)
  {
   RC = piUdfFeatureInstance-&gt;GetInputRole(i, role);
   //----------------------------------------------------------------------
   // The right Input is found
   //----------------------------------------------------------------------
   if (role == iGeometryName)
   {
    RC = piUdfFeatureInstance-&gt;GetInput(i,spGeom);
   }
   i++;
  }
  //----------------------------------------------------------------------
  // The right Input was not found
  //----------------------------------------------------------------------
  if (FAILED(RC) || role != iGeometryName)
  {
   //----------------------------------------------------------------------
   // Analyse the Outputs : this is the geometrical outputs of your Udf
   // added in the Outputs List when creating the Udf template
   //----------------------------------------------------------------------
   CATListValCATBaseUnknown_var * oOutputs = NULL;
   CATIUdfFeatureUser *piUdfFeatureUser = NULL;

   RC = iUdf-&gt;QueryInterface(IID_CATIUdfFeatureUser,(void **)&amp;piUdfFeatureUser);
   if (SUCCEEDED(RC) &amp;&amp; NULL != piUdfFeatureUser)
   { 
    //----------------------------------------------------------------------
    // Read the Outputs list
    //----------------------------------------------------------------------
    piUdfFeatureUser-&gt;GetOutputs (oOutputs);
    int OutputNb = 0;
    if (NULL != oOutputs) OutputNb = oOutputs-&gt;Size();

    //----------------------------------------------------------------------
    // At least, one output is available
    //----------------------------------------------------------------------
    if (0 &lt; OutputNb)
    {
     for (int i = 1; i &lt;= OutputNb &amp;&amp; role != iGeometryName; i++)
     {
      RC = piUdfFeatureUser-&gt;GetOutputRole (i, role);
      //----------------------------------------------------------------------
      // The right Output is found
      //----------------------------------------------------------------------
      if (role == iGeometryName)
      {
       spGeom = (*oOutputs)[i];
      }
     } 
    }
    if (NULL != oOutputs) delete oOutputs;
   }
   if (NULL != piUdfFeatureUser) piUdfFeatureUser-&gt;Release();
   piUdfFeatureUser = NULL;
  }

  oGeometry = spGeom;
 }

 if (NULL_var != oGeometry)
  RC = S_OK;
 else
  RC = E_FAIL;

 if (NULL != piUdfFeatureInstance) piUdfFeatureInstance-&gt;Release();
 piUdfFeatureInstance = NULL;

 return (RC);
}
</pre>
    </td>
  </tr>
</table>
<p>Update the interface dictionary, that is a file named, for example in this
case, CAAManufacturingItf.edu.dico, whose directory's pathname is concatenated
at run time in the CATDictionaryPath environment variable, and containing the
following declaration to state that the <i>UdfFeature</i> feature implements the
<i>CATIMfgMacroMotionsGeomMapping</i> interface, and whose code is located in
the libCAAMaiUserDefFeatureMapping shared library or DLL. Pay attention to
remove the comment (#) in the supplied dictionary.</p>
<pre>UdfFeature CATIMfgMacroMotionsGeomMapping libCAAMaiUserDefFeatureMapping</pre>
<p>The CAAManufacturingItf.edu.dico file is located in:</p>
<table width="100%">
  <tr>
    <td>Windows</td>
    <td><code>InstallRootDirectory\CAADoc\CAAManufacturingItf.edu\CNext\code\dictionary\</code></td>
  </tr>
  <tr>
    <td>Unix</td>
    <td><code>InstallRootDirectory/CAADoc/CAAManufacturingItf.edu/Cnext/code/dictionary/</code></td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step2"></a>Creating a User Defined Feature Template and Generating
Instances</h4>
<p>Here, you will find specific informations according to the implementation of
the <i>CATIMfgMacroMotionsGeomMapping</i> interface. You can access to the User
Defined Feature commands under the Shape or Part Design Workbenches, then edit
the UserHoleWithNCMacroData User feature under the UserFeatures tree, and
display the different tab-pages, specially Inputs, Parameters and Outputs ones:</p>
<ul>
  <li>The User Defined Feature template Inputs are defined and identified to
    easily access to the geometry and return the available geometry for macro
    motions.</li>
  <li>The necessary attributes are published and identified by a specific name
    (necessary to compute NC formulas from User Features parameters).</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step3"></a>Applying the
&quot;MachiningProcessUsingMacroMotionsMapping&quot; Machining Process</h4>
To apply this machining process, update the&nbsp;
&quot;CAAPrismaticMachiningItf.edu.dico&quot; file that enables to use a Profile
Contouring operation for the described user feature. In other case, use the
&quot;CounterBoringUsingMacroMotionsMapping&quot; machining process instead of
the &quot;MachiningProcessUsingMacroMotionsMapping&quot; one.
<p>&nbsp;</p>
<ul>
  <li>Open the &quot;Manufacturing Features View&quot;</li>
  <li>Open the &quot;CAAMaiMachiningProcesses.catalog&quot; catalog in the
    installation directory (see above), then select the
    &quot;MachiningProcessUsingMacroMotionsMapping&quot; process</li>
  <li>Select either in the model, or in the Manufacturing View, the
    &quot;UdfHoleWithNCMacroData.1&quot; User Defined Feature.</li>
  <li>Select the &quot;OK&quot; command
    <p>Note that two operations are created in the Machining Program</p>
  </li>
  <li>Replay them, edit them and note that information are linked to the
    &quot;UserHoleWithNCMacroData.1&quot; User Defined Feature, specially in the
    NC Macro tab-page</li>
</ul>
<p>In the following picture, the geometrical macro motions (go to a plane + go
to a point + go to a plane) are solved from the CAA implementation:</p>
<p align="center">.<img border="0" src="images/CAAMaiMPMappingonMacroMotion1.gif" width="433" height="734"></p>
<p align="left">The following picture shows the toolpath.</p>
<p align="center"><img border="0" src="images/CAAMaiMPMappingonMacroMotion2.gif" width="490" height="549"></p>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="InShort"></a>In Short</h3>
<p>This article provides an example on how to use the manufacturing interface
classes, to machine User Defined Features. It shows how to implement the <i>CATIMfgMacroMotionsGeomMapping</i>
interface to be authorized to assign geometry&nbsp; to the geometrical macro
motions when instantiating a machining process. This is an elementary step to do
this.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="References"></a>References</h3>
<table width="100%">
  <tr>
    <td valign="top">[1]</td>
    <td><a href="../CAADocUseCases/CAADocRunSample.htm">Building
      and Launching a CAA V5 Use Case</a></td>
  </tr>
  <tr>
    <td valign="top"></td>
    <td></td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="History"></a>History</h3>
<table width="100%">
  <tr>
    <td valign="top">Version: <strong>1</strong> [January 2003]</td>
    <td valign="top">Document created</td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<p><i>Copyright © 2003, Dassault Systèmes. All rights reserved.</i></p>
<p>&nbsp;</p>

</body>

</html>
