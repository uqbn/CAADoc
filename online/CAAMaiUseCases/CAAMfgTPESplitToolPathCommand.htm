<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Splitting a Tool Path</title>
<link rel="Stylesheet" type="text/css" href="../CAADocStyleSheets/caav5.css">
</head>

<body>

<table width="100%">
  <tr>
    <td valign="top">
      <h1>Machining</h1>
    </td>
    <td valign="top">
      <h2>NC Review</h2>
    </td>
    <td align="right" valign="top" rowspan="2">
      <h3><a name="Top"></a>Splitting a Tool Path</h3>
      <i>Manipulating a tool path</i></td>
  </tr>
  <tr>
    <td colspan="2" class="use">Use Case</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<table class="abstract">
  <tr>
    <td>
      <h3>Abstract</h3>
      This article discusses the CAAMfgTPESplitToolPathCommand use case.
      <ul>
        <li><b><a href="#Learn">What You Will Learn With This Use Case</a></b></li>
        <li><b><a href="#UseCase">The CAAMfgTPESplitToolPathCommand Use Case</a></b></li>
        <ul>
          <li><a href="#What">What Does CAAMfgTPESplitToolPathCommand Do</a></li>
          <li><a href="#How">How to Launch CAAMfgTPESplitToolPathCommand</a></li>
          <li><a href="#Where">Where to Find the CAAMfgTPESplitToolPathCommand
            Code</a></li>
        </ul>
        <li><b><a href="#Step">Step-by-Step</a></b></li>
        <li><b><a href="#InShort">In Short</a></b></li>
        <li><b><a href="#References">References</a></b></li>
      </ul>
    </td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="Learn"></a>What You Will Learn With This Use Case</h3>
<p>This use case is intended to help you manipulate the tool path structure.
This involves the following:</p>
<ul>
  <li>Creating a command which will select a tool path, then a point on the tool
    path, and then split the selected tool path at the selected point.</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h3><a name="UseCase"></a>The CAAMfgTPESplitToolPathCommand Use Case</h3>
<p>CAAMfgTPESplitToolPathCommand is a use case of the CAAToolPathEditorItf.edu
framework that illustrates ToolPathEditor framework capabilities.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="What"></a>What Does CAAMfgTPESplitToolPathCommand Do</h4>
<p>CAAMfgTPESplitToolPathCommand runs with the document CAAMfgToolPath.CATPart
shown on <a href="#Fig1">Fig.1</a>.</p>
<table>
  <caption><a name="Fig1"></a>Fig. 1: The Tool Path of a Sweeping Operation</caption>
  <tr>
    <td><img src="images/CAAMfgTPEDisplayDistance00.jpg" border="0" width="713" height="727"></td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="How"></a>How to Launch CAAMfgTPESplitToolPathCommand</h4>
<p>To launch CAAMfgTPESplitToolPathCommand, you will need to:</p>
<ul>
  <li>Set up the build time environment, then compile CAAMfgTPEAddToolBar.m and
    CAAMfgTPESplitToolPathCommand.m modules along with its prerequisites [<a href="#References">1</a>]</li>
</ul>
<table class="code">
  <tr>
    <td>
      <pre># Decomment this line into file ToolPathEditor.edu.dico to run CAAMfgTPEAddToolBar Sample
# CAAMfgTPEM3xAddin CATISmgProgramAddin libCAAMfgTPEAddToolBar</pre>
    </td>
  </tr>
</table>
<ul>
  <li>Set up the run time environment</li>
  <li>Launch a CATIA V5 session</li>
  <li>Open the CAAMfgToolPath.CATPart file located in:</li>
  <table width="100%">
    <tr>
      <td>Windows</td>
      <td><code>InstallRootDirectory\CAADoc\CAAToolPathEditorItf.edu\CNext\resources\</code></td>
    </tr>
    <tr>
      <td>Unix</td>
      <td><code>InstallRootDirectory/CAADoc/CAAToolPathEditorItf.edu/CNext/resources/</code></td>
    </tr>
  </table>
</ul>
<table width="100%">
  <tr>
    <td><img src="images/CAAMfgTPEDisplayDistance01.jpg" width="482" height="417"></td>
    <td>Using the Start menu, select the Surfacic Machining workbench in NC
      Manufacturing</td>
  </tr>
  <tr>
    <td><img src="images/CAAMfgTPEDisplayDistance02.jpg" border="0" width="275" height="417"></td>
    <td>This displays the PPR document</td>
  </tr>
  <tr>
    <td><img src="images/CAAMfgTPEDisplayDistance03.jpg" border="0" height=267 width=327></td>
    <td>
      <ul>
        <li>In the PPR Tree, select Manufacturing Program.1 and create a
          sweeping operation using the Sweeping command in the
          Insert-&gt;Machining Operations-&gt;sweeping</li>
        <li>Select a body, then do replay to compute the tool path.</li>
        <li>In the PPR tree, an icon appears under the activity of sweeping.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><img border="0" src="images/CAAMfgTPESplitToolPath04.jpg" width="345" height="368"></td>
    <td>Then select the tool path and click on the icon representing the command
      &quot;Split tool path&quot;. A tool path is displayed, with points.</td>
  </tr>
  <tr>
    <td><img src="images/CAAMfgTPESplitToolPath05.jpg" width="352" height="345"></td>
    <td>Select a point on the tool path. Then this tool path is splitted and two
      tool pathes appear in the PPR Tree.</td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Where"></a>Where to Find the CAAMfgTPESplitToolPathCommand Code</h4>
<p>The CAAMfgTPESplitToolPathCommand use case is made of a class named <i>CAAMfgTPESplitToolPathCommand</i>
located in the CAAMfgTPESplitToolPathCommand.m module of the
CAAToolPathEditorItf.edu framework:</p>
<table width="100%">
  <tr>
    <td>Windows</td>
    <td><code>InstallRootDirectory\CAADoc\CAAToolPathEditorItf.edu\CAAMfgTPEDisplayToolPathCommand.m</code></td>
  </tr>
  <tr>
    <td>Unix</td>
    <td><code>InstallRootDirectory/CAADoc/CAAToolPathEditorItf.edu/CAAMfgTPEDisplayToolPathCommand.m</code></td>
  </tr>
</table>
<p>where <code>InstallRootDirectory</code> is the directory where the CAA CD-ROM
is installed.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h3><a name="Step"></a>Step-by-Step</h3>
<p>There are four logical steps in CAAMfgTPESplitToolPathCommand:</p>
<ol>
  <li><a href="#Step1">Creating a Command</a></li>
  <li><a href="#Step2">Selecting a Tool Path</a></li>
  <li><a href="#Step4">Selecting a Point</a></li>
  <li><a href="#Step4">Splitting the Selected Tool Path</a></li>
</ol>
<p>We now comment each of those sections by looking at the code.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step1"></a>Creating a Command</h4>
<p>The class that will implement the command is named <i>CAAMfgTPESplitToolPathCommand</i>.</p>
<p>Create the <i>CAAMfgTPESplitToolPathCommand</i> class header file:</p>
<table class="code">
  <tr>
    <td>
      <pre>class ExportedByCAAMfgTPESplitToolPathCommand CAAMfgTPESplitToolPathCom : public CATStateCommand
{
  public:
    DeclareResource (CAAMfgTPESplitToolPathCom,CATStateCommand)
    CAAMfgTPESplitToolPathCom (CATString* argument);
    virtual ~CAAMfgTPESplitToolPathCom();
    void BuildGraph();
    void Valuate (const CATBaseUnknown_var&amp; iValue);  
  private:
    // to Create the rep of the tool path
    void CreateController();
    // Delete the rep of the tool path
    void DeleteController();
    // To update the rep of the tool path
    void DispatchInfo();
    // To get the tool path
    boolean GetSelection (void* data);
    // To Terminate the command
    boolean End (void* data);
    // To split the tool path.
    boolean SplitToolPath();
    // To create the selector of points
    void SetSelector();
    // Processing of events.
    void PreActivate (CATCommand*, CATNotification*, CATCommandClientData);
    void Move (CATCommand*, CATNotification*, CATCommandClientData);
    void EndPreActivate (CATCommand*, CATNotification*, CATCommandClientData);
    // To process the selection of a point.
    void ActivateSelector (CATCommand*, CATNotification*, CATCommandClientData);
    // to search the index of the selected point
     void SetPreActivatedPoint (CATMathPoint &amp;Point);
    //  To remove the rep of the point.
    void RemovePointRep();
	//  To Get the factory of tool pathes.
	HRESULT GetToolPathFactory (CATIContainer_var&amp; oContainer);
    CATIMfgActivity_var _Activity;
    CATIMfgToolPath_var _ToolPath;
    CATIMfgTPMultipleMotion_var _TPMultipleMotion;
    CAT3DViewer*     _Viewer;
    CATPathElementAgent* _TPSelectionAgent;
    CATDialogAgent*  _TPEndAgent ;
    int   _PointNumber;
    CATPathElement* _ToolPahVisu;
    IID*            _iid;
    CATVisManager*  _VisuManager;
    CATRep*         _TPRep;          
    CAT3DPointRep*  _CurrentPointRep;
    CATSelector*    _Selector;        
};</pre>
    </td>
  </tr>
</table>
<p>The <i>CAAMfgTPESplitToolPathCommand</i> class C++-derives from <i>CATStateCommand</i>.
The DeclareResource macro declares that the resource file is <i>CAAMfgTPESplitToolPathCommand.CATNls.</i>
The class has a constructor, a destructor, a <code>SplitToolPath</code> method
to split the selected tool path, severals methods to manage the user's
interaction and the rep of the tool path, and a copy constructor.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step2"></a>Selecting a Tool Path</h4>
<p>First you have to implement the method BuilGraph, which will provide you with
capturing the user's interactions.</p>
<table class="code">
  <tr>
    <td>
      <pre>void CAAMfgTPESplitToolPathCom::BuildGraph()
{  
  // To Select tool path.
  _TPSelectionAgent = new CATPathElementAgent(&quot;ToolPathSelection&quot;);
  if (NULL != _TPSelectionAgent) {
    _TPSelectionAgent-&gt;SetOrderedElementType(CATIMfgCompoundTraject::ClassName());
    _TPSelectionAgent-&gt;SetBehavior(CATDlgEngWithPrevaluation|CATDlgEngWithCSO|CATDlgEngMultiAcquisition);
    AddCSOClient(_TPSelectionAgent);
  }
  // To terminate the command
  if ( _TPEndAgent == NULL ) {
    _TPEndAgent = new CATDialogAgent(&quot;End&quot;);
    if (NULL != _TPEndAgent)
      _TPEndAgent-&gt;AcceptOnNotify(NULL, CATEdit::ClassName());
  }
  CATDialogState* firstState = GetInitialState(&quot;TPESelectToolPath&quot;);
  if (NULL != firstState) firstState-&gt;AddDialogAgent(_TPSelectionAgent); 
  CATDialogState* secondState = AddDialogState(&quot;TPEEndCommand&quot;);
  if (NULL != secondState)
    secondState-&gt;AddDialogAgent(_TPEndAgent); 
    CATDialogTransition * firstTransition = 
        AddTransition (firstState, secondState,
                       IsOutputSetCondition(_TPSelectionAgent),
                       Action((ActionMethod) &amp;CAAMfgTPESplitToolPathCom::GetSelection));
    AddTransition (secondState, NULL,
                   IsOutputSetCondition(_TPEndAgent),
                   Action((ActionMethod) &amp;CAAMfgTPESplitToolPathCom::End));
}</pre>
    </td>
  </tr>
</table>
<p>Now the method GetSelection is implemented. It gets the selected tool path.</p>
<table class="code">
  <tr>
    <td>
      <pre>boolean CAAMfgTPESplitToolPathCom::GetSelection (void* data)
{ 
  CATBoolean RESULT = CATFalse;
  CATSO* selectedObjects = NULL;
  if (NULL != _TPSelectionAgent)
    selectedObjects = _TPSelectionAgent-&gt;GetListOfValues();
  
  // We display only one tool path in this command
  if ( selectedObjects ) {
    if ( selectedObjects-&gt;GetSize() == 1 ) {
      CATPathElement* pathElement=NULL;
      CATIMfgCompoundTraject* ptrCTraject=NULL;
      CATIMfgCompoundTraject_var itfCmpTraject;
      pathElement = (CATPathElement*) (*selectedObjects)[0];
      if (NULL != pathElement) {
        // A CATIMfgCOmpoundTraject must have been seletecd
        ptrCTraject = (CATIMfgCompoundTraject *) (pathElement-&gt;FindElement(CATIMfgCompoundTraject::ClassId()));
        itfCmpTraject = ptrCTraject;
        if (!! itfCmpTraject ) {
          _ToolPath = itfCmpTraject;
          CATIMfgToolPathComponents_var itfComponents =_ToolPath;
          CATListValCATBaseUnknown_var* Liste = NULL;
          if (!!itfComponents) Liste = itfComponents-&gt;GetAllElements();
          if ( Liste )
          {
            _TPMultipleMotion = (*Liste)[1];
            delete Liste;
          }
          ptrCTraject-&gt;Release();
          ptrCTraject=NULL;
          RESULT = CATTrue;
          // We get the activity to be able to redraw the tree under the corresponding activity.
          CATIMfgActivity* ptrActivity = (CATIMfgActivity *) (pathElement-&gt;FindElement(CATIMfgActivity::ClassId()));
          if (NULL != ptrActivity ) {
            _Activity = ptrActivity;
            ptrActivity-&gt;Release();
            ptrActivity=NULL;
          }
        }
        pathElement=NULL;
      }
      // Display the tool path.
      CreateController();
      DispatchInfo();
      // To Select points.
      SetSelector();
    }
  }
  return RESULT;
}</pre>
    </td>
  </tr>
</table>
<p>First, we verify that the selected object is a tool path object, then we
display it (call to methods CreateController to create the image then a call to
method DispatchInfo to display it in the 3d viewer). Then we create a selector
to select points on a tool path.</p>
<table class="code">
  <tr>
    <td>
      <pre>void CAAMfgTPESplitToolPathCom::SetSelector() 
{
  // To get the rep of the points
  CATIMfg3DToolPathVisuData_var VisuData (_ToolPath);
  if (!! VisuData) { 
    if ( SUCCEEDED(VisuData-&gt;GetPointsRep(&amp;_TPRep) ) ) {
      if ( _Selector == NULL ) {
        _Selector = new CATSelector (this,&quot;ToolPathSelector&quot;, _TPRep);
        AddAnalyseNotificationCB ( _Selector,
                                   _Selector-&gt;GetCATPreactivate(),
                                   (CATCommandMethod)&amp;CAAMfgTPESplitToolPathCom::PreActivate,NULL);
        AddAnalyseNotificationCB ( _Selector,
                                   _Selector-&gt;GetCATActivate(),
                                  (CATCommandMethod)&amp;CAAMfgTPESplitToolPathCom::ActivateSelector,NULL);
        AddAnalyseNotificationCB ( _Selector,
                                   _Selector-&gt;GetCATMove(),
                                   (CATCommandMethod)&amp;CAAMfgTPESplitToolPathCom::Move,NULL);
        AddAnalyseNotificationCB ( _Selector,
                                   _Selector-&gt;GetCATEndPreactivate(),
                                   (CATCommandMethod)&amp;CAAMfgTPESplitToolPathCom::EndPreActivate,NULL);
      }
      else {
       _Selector-&gt;AssociateToRep(_TPRep);
      }
    }
  }
}</pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step3"></a>Selecting a Point</h4>
<p>The method Activateselector is called when an end-user click on a point of
the tool path.</p>
<table class="code">
  <tr>
    <td>
      <pre>void CAAMfgTPESplitToolPathCom::ActivateSelector(CATCommand* c1, CATNotification* c2, CATCommandClientData c3)
{
  CATGraphicElementIntersection* Intersection = NULL;
  if (NULL != _Selector) 
  {
    Intersection = (CATGraphicElementIntersection*) 
            _Selector-&gt;SendCommandSpecificObject (CATGraphicElementIntersection::ClassName(), c2);
  }
  if (!Intersection) return;
  CATMathPoint point = Intersection-&gt;point;
  Intersection-&gt;Release();
  SetPreActivatedPoint(point);
   
  // To split the tool path at the selected point.
  if ( SplitToolPath() )
    End(NULL);
  if ( _Viewer) _Viewer-&gt;Draw();
}</pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step4"></a>Splitting the Selected Tool Path</h4>
<p>The next is to split the tool path at the selected point and to display this
information in the PPR Tree.</p>
<table class="code">
  <tr>
    <td>
      <pre>boolean CAAMfgTPESplitToolPathCom::SplitToolPath()
{  
  boolean isSplit=FALSE;
  if ( !! _TPMultipleMotion ) {
    if ( _PointNumber &gt; 1 &amp;&amp; _PointNumber &lt; _TPMultipleMotion-&gt;GetNumberOfTipPoints() ) {
      CATIMfgTPTransformation_var itfTransformation (_TPMultipleMotion);
      if (!! itfTransformation) {
        CATIMfgTPMultipleMotion_var MultipleMotion2 (NULL_var);
        if ( itfTransformation-&gt;Split (_PointNumber,MultipleMotion2) ) {
          // To Store the datas int the model.
          CATIMfgTPSaveData_var itfSaveData1 = _TPMultipleMotion;
          if ( !!itfSaveData1)
            itfSaveData1-&gt;SaveData ();
          CATIMfgTPSaveData_var itfSaveData2 = MultipleMotion2;
          if ( !!itfSaveData2)
            itfSaveData2-&gt;SaveData ();
          
          // We must create two new MfgCompoundTraject.
          // Each will have only one MfgpMultipleMotion.
          // At the end, we must have
          // MfgCompoundTraject -
          //                    MfgCompoundTraject 1 -
          //                             MfgMultipleMotion
          //                    MfgCompoundTraject 2
          //                             MfgMultipleMotion
          CATIMfgToolPathFactory_var spTPFactory;
          CATIContainer_var spContainer;
          GetToolPathFactory (spContainer);
          spTPFactory = spContainer;
          CATIMfgCompoundTraject_var itfCompound1=NULL_var;
          CATIMfgCompoundTraject_var itfCompound2=NULL_var;
          if (NULL_var!=spTPFactory) {
             itfCompound1 = spTPFactory-&gt;CreateMfgCompoundTraject ();
             itfCompound2 = spTPFactory-&gt;CreateMfgCompoundTraject ();
            CATIMfgToolPathComponents_var itfComponents1(itfCompound1);
            if ( !! itfComponents1 )
              itfComponents1-&gt;AddElement(_TPMultipleMotion);
            CATIMfgToolPathComponents_var itfComponents2(itfCompound2);
            if ( !! itfComponents2 )
              itfComponents2-&gt;AddElement(MultipleMotion2);
            CATIMfgToolPathComponents_var itfComponents(_ToolPath);
            if ( !! itfComponents &amp;&amp; !! itfComponents1 &amp;&amp; !! itfComponents2 ) {
              isSplit = TRUE;
              // To mark each MfgCompoundTraject as a sub tool path
              itfCompound1-&gt;SetSubToolPathFlag(CATTrue);
              itfCompound2-&gt;SetSubToolPathFlag(CATTrue);
              itfComponents-&gt;RemoveAll();
              itfComponents-&gt;AddElement(itfCompound1);
              itfComponents-&gt;AddElement(itfCompound2);
              // To displat these two tool path in the tree.
              if ( !!_Activity ) {
                CATIRedrawEvent_var Event(_Activity-&gt;GetImpl());
                if (!!Event) Event-&gt;Redraw();
              }
            }
          }
        }
      }
    }
  }
  return isSplit;
}</pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="InShort"></a>In Short</h3>
<p>This article provides an example on how to use the structure of the tool path
and how to make the split of a the tool path.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="References"></a>References</h3>
<table width="100%">
  <tr>
    <td valign="top">[1]</td>
    <td><a href="../CAADocUseCases/CAADocRunSample.htm">Building
      and Launching a CAA V5 Use Case</a></td>
  </tr>
  <tr>
    <td valign="top">[2]</td>
    <td><a href="CAAMaiDumpToolPathCommand.htm">Dump of Tool Path Content
      Command</a></td>
  </tr>
  <tr>
    <td align="right" valign="top" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="History"></a>History</h3>
<table width="100%">
  <tr>
    <td valign="top">Version: <b>1</b> [March 2002]</td>
    <td valign="top">Document created</td>
  </tr>
  <tr>
    <td align="right" valign="top" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<p><i>Copyright © 2002, Dassault Systèmes. All rights reserved.</i>

</body>

</html>
