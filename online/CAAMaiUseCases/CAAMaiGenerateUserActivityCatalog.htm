<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Generating a Catalog of User Defined NC Operations</title>
<link rel="Stylesheet" type="text/css" href="../CAADocStyleSheets/caav5.css">
</head>

<body>

<table width="100%">
  <tr>
    <td valign="top">
      <h1>Machining</h1>
    </td>
    <td valign="top">
      <h2>NC Review</h2>
    </td>
    <td rowspan="2" align="right" valign="top">
      <h3><a name="Top"></a>Generating a Catalog of User Defined NC Operations</h3>
      <em>Defining User Defined NC Operations</em></td>
  </tr>
  <tr>
    <td class="use" colspan="2">Use Case</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->

<table class="abstract">
  <tr>
    <td>
      <h3>Abstract</h3>
      <p>This article discusses the CAAMaiGenerateUserActivityCatalog use case
      and explains how to generate and upgrade a catalog of User Defined Operations.</p>
      <ul>
        <li><a href="#Learn"><strong>What You Will Learn With This Use Case</strong></a></li>
        <li><a href="#UseCase"><strong>The CAAMaiGenerateUserActivityCatalog Use
          Case</strong></a>
          <ul>
            <li><a href="#What">What Does CAAMaiGenerateUserActivityCatalog Do</a></li>
            <li><a href="#How">How to Launch CAAMai</a><a href="#What">GenerateUserActivityCatalog</a></li>
            <li><a href="#Where">Where to Find the
              CAAMaiGenerateUserActivityCatalog Code</a></li>
          </ul>
        <li><a href="#Step"><strong>Step-by-Step</strong></a></li>
        <li><b><a href="#InShort">In Short</a></b></li>
        <li><b><a href="#References">References</a></b></li>
      </ul>
    </td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="Learn"></a>What You Will Learn With This Use Case</h3>
<p>This use case is intended to help you to generate a new catalog of User
Defined Operation. This involves the following:&nbsp;</p>
<ul>
  <li>Creating a new Library of Activities.</li>
  <li>Add a new Startup in this library.</li>
  <li>Add Strategy parameters on this Startup.</li>
  <li>Save the Activities Catalog.</li>
</ul>
    <p>
        This use case also shows how to upgrade an existing catalog of User Defined Operation.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h3><a name="UseCase"></a>The CAAMaiGenerateUserActivityCatalog Use Case</h3>
<p>CAAMaiGenerateUserActivityCatalog is a use case of the
CAAManufacturingItf.edu framework that illustrates how to generate a new catalog
of User Defined operations and how
    to upgrade it.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="What"></a>What Does CAAMaiGenerateUserActivityCatalog Do</h4>
<p>CAAMaiGenerateUserActivityCatalog&nbsp; enables the customer to generate a
new activities catalog containing a new startup of User Defined Operation. This
startup is named &quot;UserActivity&quot;. The User Defined Operation use a
&quot;MfgHole&quot; machining feature which is a standard machining feature
defined in the Manufacturing.feat catalog. This operation has two strategy
parameters (&quot;Offset&quot; and &quot;NbOfCuts&quot;).</p>
    <p>
        Then the use case allows to upgrade an existing activities catalog adding a new
        strategy parameter ("AdditionalParam").</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->
<h4><a name="How"></a>How to Launch CAAMaiGenerateUserActivityCatalog</h4>
<p>To launch CAAMaiGenerateUserActivityCatalog, you will need to:</p>
<ul>
  <li>Set up the build time environment, then compile
    CAAMaiGenerateUserActivityCatalog.m module along with its prerequisites [<a href="#References">1</a>]</li>
  <li>Set up the run time environment</li>
  <li>Uncomment the following lines in the use case code</li>
</ul>
<blockquote>
    <p>
        //if ( Upgrade ) 
        <br />
        // &nbsp;&nbsp; SaveCatalog( &amp;piClientCatalog, &amp;NewPathCatalog
        ); 
        <br />
        //else 
        <br />
        // &nbsp;&nbsp; CATDocumentServices::SaveAs(*lib,PathCatalog);
    </p>
</blockquote>
<ul>
  <li>Change the value of the variable "Upgrade" according to your need: creation of a
      new catalog or upgrade of an existing one<br />
      <br />
      // Set this variable to CATTrue to activate the upgrade mode
      <br />
      CATBoolean Upgrade = CATFalse;
      <br />
      &nbsp;</li><li>Build and launch the executable CAAMaiGenerateUserActivityCatalog. </li>
    <li>This will generate the catalog "UserActivityCatalog.CATfct" in creation mode or
        "NewUserActivityCatalog.CATfct" in upgrade mode. </li>
  <li>Copy the &quot;UserActivityCatalog.CATfct&quot; catalog in the runtime view or
      rename "NewUserActivityCatalog.CATfct" in "UserActivityCatalog.CATfct" and copy
      it in the runtime view.</li></ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Where"></a>Where to Find the CAAMaiGenerateUserActivityCatalog Code</h4>
<p>The CAAMaiGenerateUserActivityCatalog use case is made of a main named <i>CAAEMaiUserActivityCatalogMain</i>
located in the CAAMaiGenerateUserActivityCatalog.m module of the
CAAManufacturingItf.edu framework:</p>
<table>
  <tr>
    <td>Windows</td>
    <td><code>InstallRootDirectory\CAADoc\CAAManufacturingItf.edu\CAAMaiGenerateUserActivityCatalog.m</code></td>
  </tr>
  <tr>
    <td>Unix</td>
    <td><code>InstallRootDirectory/CAADoc/CAAManufacturingItf.edu/CAAMaiGenerateUserActivityCatalog.m</code></td>
  </tr>
</table>
<p>where <code>InstallRootDirectory</code> is the directory where the CAA CD-ROM
is installed.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step"></a>Step-by-Step</h4>
<p>There are four logical steps in CAAMaiGenerateUserActivityCatalog for the creation
    of a new activities catalog:</p>
<ol>
  <li><a href="#Step1">Create a new library of Activities</a></li>
  <li><a href="#Step2">Create a startup in this catalog</a>&nbsp;</li>
  <li><a href="#Step3">Add strategy parameters to the startup</a></li>
  <li><a href="#Step4">Save the new Catalog</a></li>
</ol>
<p>
    This use case also shows how to <a href="#UpgradeParagraph">upgrade an existing catalog of User Defined Operation</a>.
    The upgrade process is also based on four steps:</p>
    <ol>
    <li><a href="#UpgradeStep1">Upgrade an existing catalog</a></li>
    <li><a href="#UpgradeStep2">Retrieve the existing startup in this catalog</a></li>
    <li><a href="#UpgradeStep3">Add strategy parameters to the startup</a></li>
    <li><a href="#UpgradeStep4">Save the Catalog</a> </li>
    </ol>
    <p>
        We now comment each of those sections by looking at the code.</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step1"></a>Creating a new library of activities</h4>
  <p>You have to create a new document of CATFct type.&nbsp;</p>
<table class="code" width="1020">
  <tr>
    <td width="1012">
      <pre>//Creation of a new activities catalogue
CATDocument* lib=NULL;
CATDocumentServices::New(&quot;CATfct&quot;,lib);

//Initialize root container
CATIMfgCatalogFactories *piFact=NULL;

CATString ClassName(&quot;CATMfgCatalogFactories&quot;);
CATInstantiateComponent (ClassName,
			CATIMfgCatalogFactories::ClassId(),
			(void**)&amp; piFact);
if (piFact == NULL) return 1;

CATIContainer_var cont;
HRESULT RC = piFact-&gt;CreateActivityRootCont(lib,cont);
if (piFact) piFact-&gt;Release();

if (S_OK != RC || NULL_var == cont) return 2;

		
CATInit_var pInitOnDoc = lib;    
if (NULL_var == pInitOnDoc) return 3;
if (NULL_var != pInitOnDoc) 
{
  //pInitOnDoc-&gt;Init(FALSE);
  CATBaseUnknown *  BidVar = pInitOnDoc -&gt; GetRootContainer(CATIContainer::ClassName());
  if (NULL != BidVar) 
  {
    CATIContainer_var ActivityCatalog = BidVar;
    BidVar-&gt;Release();
    BidVar = NULL;
    HRESULT RC = S_OK;
				
    CATICatalog_var hCatalogTemp = ActivityCatalog;
    if (NULL_var != hCatalogTemp)
    {
	CATUnicodeString TOTO = &quot;CLIENT&quot;;
	HRESULT HRID = hCatalogTemp-&gt; SetClientId (&amp;TOTO);
    }
  }
}</pre>
    </td>
  </tr>
</table>
<ol>
</ol>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<!---------------------------------comment------------------------------------->

<h4><a name="Step2"></a>Create a startup in this catalog</h4>
<p>To define the startup of a new User Defined Operation you should derivate
from the startup &quot;MfgUserDefinedMO&quot; which is defined in the
ManufacturingActivities.feat catalog. So&nbsp; ManufacturingActivities.feat is a
prerequisit catalog and you need to load it.&nbsp;</p>
<p>If you want your User Defined Operation will use a predefined Machining
Feature, the Manufacturing.feat is a prerequisit catalog too. In this use case,
the Operation we want to define uses the &quot;MfgHole&quot; Machining Feature.
But you can define your own Machining Feature by generating a new *.CATfct
Catalog (This is fully described in the referenced article [<a href="#References">2</a>].).
The only specific point is that your feature startup have to derivate from the
&quot;MachiningFeature&quot; startup which is defined in Manufacturing.feat
catalog).</p>

<p>In the new catalog we create a new startup of type &quot;UserActivity&quot;
derivating from the startup &quot;MfgUserDefinedMO&quot; defined in the
ManufacturingActivities.feat catalog and associate a predefined Machining 
Feature &quot;MfgHole&quot; to this startup.</p>
<p>You can also associate your own Machining Feature. In this case you have to 
first generating a new *.CATfct
Catalog (This is fully described in the referenced article [<a href="#References">2</a>].) 
The only specific point is that your feature startup have to derivate from the &quot;MachiningFeature&quot; 
startup. To create this startup you should use the service 
CATMfgMachFeatureSUFactory. In this case, you have to load your own Catalog 
containing your Machining Feature startup by using the CATCatologFactoryServices, 
before trying to create the new activity startup. Your catalog becomes a 
prerequisit.</p>
<p>&nbsp;</p>
<table class="code">
  <tr>
    <td>
      <pre>CATISpecObject *piNewStartUp = NULL; 
const CATUnicodeString pActivityTypeName = &quot;UserActivity&quot;; 
CATISPPActivityTypeFactory *piRootActivity = NULL;  
...
//============================================================================= 
// 2- Create a startup in this catalog 
//============================================================================= 
//Retrive Client Catalog if (NULL_var != cont) 
rc = cont -&gt; QueryInterface(IID_CATICatalog, (void**) &amp;piClientCatalog); 
if (FAILED(rc)) return 4; 
if (NULL == piClientCatalog) return 5;
 
//Retrieve activities library document root container 
if (NULL_var != pInitOnDoc ) 
    piRootActivity = (CATISPPActivityTypeFactory* )pInitOnDoc-&gt;GetRootContainer("CATISPPActivityTypeFactory"); 
else 
    piClientCatalog -&gt; QueryInterface( IID_CATISPPActivityTypeFactory, (void**) &amp;piRootActivity ); 

CATIContainer *piActivityCont = NULL; 
if (NULL != piRootActivity) 
    rc = piRootActivity -&gt; QueryInterface(IID_CATIContainer, (void**) &amp;piActivityCont); 
if (FAILED(rc)) return 6; 
if (NULL == piActivityCont) return 7;
 
// Create the Startup 
const CATUnicodeString pActivitySuperTypeName = &quot;MfgUserDefinedMO&quot;; 
CATListOfCATUnicodeString pFeatureTypeNameList; 
pFeatureTypeNameList.Append(&quot;MfgHole&quot;);
 
CATIMfgStartupFactories *piSUFact=NULL;
 
CATString ClassNameSU(&quot;CATMfgStartupFactories&quot;); 
CATInstantiateComponent (ClassNameSU, CATIMfgStartupFactories::ClassId(), (void**)&amp; piSUFact);
 
if (NULL == piSUFact) return 8; 
rc = piSUFact-&gt;CreateMachiningOperationSU(&amp;piNewStartUp, 
                                           piClientCatalog, 
                                           piActivityCont, 
                                           pActivityTypeName, 
                                           pActivitySuperTypeName, 
                                           pFeatureTypeNameList); </pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step3"></a>Add strategy parameters to the startup</h4>
<p>Then we add two new strategy parameters &quot;Offset&quot; and
&quot;NbOfCuts&quot; to the startup by using the interface <i>CATIMfgManufacturingParameters</i>
. Those two parameters will be accessible in the strategy tabpage of the User
Defined Operation edition panel.&nbsp;</p>
<p>In order to be able to use the interface <i>CATIMfgManufacturingParameters</i>
you should have to create an instance of the class <i>CATMfgManufacturingParameters</i>
with the interface <i>CATIInstancianteComponent.</i></p>
<table class="code">
  <tr>
    <td>
      <pre>...
//=============================================================================
// 3- Add strategy parameters to this startup 
//=============================================================================
// - Definition of the container in which we want to create instances
CATICkeParmFactory_var ParmFactInst(cont);
if (NULL_var == ParmFactInst) return 9;

CATIMfgManufacturingParameters *piParm =NULL;

ClassName = &quot;CATMfgManufacturingParameters&quot;;
CATInstantiateComponent (ClassName,
CATIMfgManufacturingParameters::ClassId(),
(void**)&amp; piParm);


// Add strategy parameters
CATBaseUnknown *pObj = NULL;
if (NULL != piNewStartUp)
rc = piNewStartUp -&gt; QueryInterface(IID_CATBaseUnknown,(void**) &amp;pObj);
CATBaseUnknown_var hObj(pObj); 

CATICkeParmFactory_var FactL(piRootActivity);

if (NULL != piParm &amp;&amp; NULL_var != ParmFactInst)
{
  CATICkeParm_var Param = ParmFactInst-&gt;CreateLength(&quot;Offset&quot;, 0.0);
  rc = piParm-&gt;AddStrategyParameterToActivity (hObj,&quot;Offset&quot;,Param);

  Param = ParmFactInst-&gt;CreateInteger(&quot;NbOfCuts&quot;, 1);
  rc = piParm-&gt;AddStrategyParameterToActivity (hObj,&quot;NbOfCuts&quot;,Param);

  piParm-&gt;Release();
}

if (NULL != pObj) 
  pObj -&gt; Release();
pObj = NULL;

if (NULL != piRootActivity) 
  piRootActivity -&gt; Release();
piRootActivity = NULL;</pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
<h4><a name="Step4"></a>Save the new catalog</h4>
<p>Finally you just have to save your catalog and delete the session.&nbsp;</p>
<table class="code">
  <tr>
    <td>
      <pre> ...
 // Save the catalog
CATUnicodeString  PathCatalog =&quot;E:\\tmp\\UserActivityCatalog.CATfct&quot;;</pre>
      <pre>CATDocumentServices::SaveAs(*lib,PathCatalog);

// delete the session, removes the opened documents also.
// never forget to delete a creating session after usage.
rc = ::Delete_Session(&quot;Session_perso&quot;);</pre>
    </td>
  </tr>
</table>
<p align="right">[<a href="#Top">Top</a>]</p>
    <h4><a name="UpgradeParagraph"></a>Upgrade an existing catalog of activities</h4>
    <p>
        The upgrade process is also based on four steps:</p><ol>
    <li><a href="#UpgradeStep1">Upgrade an existing catalog</a>&nbsp;</li>
    <li><a href="#UpgradeStep2">Retrieve the existing startup in this catalog</a> </li>
    <li><a href="#UpgradeStep3">Add strategy parameters to the startup</a> </li>
    <li><a href="#UpgradeStep4">Save the Catalog</a> </li>
</ol>
    <p>
        Don't forget to change the value of the variable "Upgrade" to CATTrue in the code
        of CAAMaiGenerateUserActivityCatalog.<br />
        <br />
        <table class="code">
            <tr>
                <td>
                    <pre>// Set this variable to CATTrue to activate the upgrade mode <br />CATBoolean Upgrade = CATTrue; &nbsp;</pre>
                </td>
            </tr>
        </table>
    </p>
    <h5>
        <a name="UpgradeStep1"></a>Upgrade an existing catalog</h5>
    <p>
        The general API to update a feature catalog is used.</p>
    <p>
        <table class="code">
            <tr>
                <td>
                    <pre> ::UpgradeCatalog( &amp;PathCatalog, &amp;piClientCatalog, &amp;ClientId );&nbsp;</pre>
                </td>
            </tr>
        </table>
    </p>
    <h5>
        <a name="UpgradeStep2"></a>Retrieve the existing startup in this catalog</h5>
    <p>
        Use the API RetrieveSU of <em>CATICatalog</em> interface to retrieve the startup.</p>
    <p>
        <table class="code">
            <tr>
                <td>
					<pre>const CATUnicodeString StartUpType = pActivityTypeName;
CATBaseUnknown* pNewStartUpObject = NULL;</pre>
					<pre>rc = activityCatalog-&gt;RetrieveSU(&amp;pNewStartUpObject,&amp;StartUpType,CATISpecObject::ClassName());</pre>
					<pre>if (SUCCEEDED(rc) &amp;&amp; NULL != pNewStartUpObject)
{
    rc = pNewStartUpObject-&gt;QueryInterface(IID_CATISpecObject,(void**)&amp;piNewStartUp);</pre>
					<pre>    pNewStartUpObject-&gt;Release();
    pNewStartUpObject = NULL;
    cout &lt;&lt; &quot;Startup &quot; &lt;&lt; pActivityTypeName.ConvertToChar() &lt;&lt; &quot; retrieved&quot; &lt;&lt; endl;
} </pre>
					
                </td>
            </tr>
        </table>
    </p>
    <h5>
        <a name="UpgradeStep3"></a>Add strategy parameters to the startup</h5>
    <p>
        This is done the same way than for creation.</p>
    <h5>
        <a name="UpgradeStep4"></a>Save the Catalog</h5>
    <p>
        &nbsp;Saving the catalog is done through the global function SaveCatalog.&nbsp;</p>
    <p>
        <table class="code">
            <tr>
                <td>
                    <pre>
CATUnicodeString NewPathCatalog ="C:\\tmp\\NewUserActivityCatalog.CATfct"; <p>if ( Upgrade )
</p><p>    SaveCatalog( &amp;piClientCatalog, &amp;NewPathCatalog );
</p></pre>
                </td>
            </tr>
        </table>
    </p>
    <p>
        Don't forget to uncomment the two above lines, then to rename the generated file
        "NewUserActivityCatalog.CATfct" in "UserActivityCatalog.CATfct" and finally to copy it in the
        runtime view.</p>
    <p align="right">
        [<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="InShort"></a>In Short</h3>
<p>This article provides an example on how to generate and upgrade a catalog of
manufacturing User Defined Operations.</p>
<p>In this example we generate a catalog named
&quot;UserActivityCatalog.CATfct&quot; that contains one startup of a User Defined Operation. The late type of this operation is &quot;UserActivity&quot;. It
derivates from the late type &quot;MfgUserDefinedMO&quot; as every user defined
operation should do it. The &quot;MfgUserDefinedMO&quot; is a standard user
defined operation. The corresponding startup of this operation is defined in the
ManufacturingActivities.feat catalog.</p>
<p>For this user defined activity we authorized the &quot;MfgHole&quot;
machining feature, which is a standard drilling machining feature defined in the
Manufacturing.feat catalog.</p>
<p>We also add on this startup two different strategy parameters
&quot;Offset&quot; and &quot;NbOfCuts&quot;.</p>
    <p>
        The way to upgrade this catalog in order to add another parameter for instance is
        also described.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="References"></a>References</h3>
<table width="100%">
  <tr>
    <td valign="top">[1]</td>
    <td><a href="../CAADocUseCases/CAADocRunSample.htm">Building
      and Launching a CAA V5 Use Case</a></td>
  </tr>
  <tr>
    <td valign="top">[2]</td>
    <td><a href="../CAAOsmUseCases/CAAOsmAppliCont.htm">Creating
      Features in an Applicative Container</a></td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="History"></a>History</h3>
<table width="100%">
  <tr>
    <td valign="top">Version: <strong>1</strong> [Apr 2001]</td>
    <td valign="top">Document created</td>
  </tr>
  <tr>
    <td valign="top">Version: <strong>2</strong> [Mar 2004]</td>
    <td valign="top">Document modification</td>
  </tr>
    <tr>
        <td valign="top">
            Version: <strong>3</strong> [May 2007]</td>
        <td valign="top">
            Add information on catalog upgrade</td>
    </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<p><i>Copyright © 2001, Dassault Systèmes. All rights reserved.</i></p>

<p>&nbsp;</p>

</body>

</html>
