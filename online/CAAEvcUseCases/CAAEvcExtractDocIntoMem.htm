<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="Stylesheet" type="text/css" href="../CAADocStyleSheets/caav5.css">
<title>Extracting a Document from the Vault Server to a Memory Area</title>
</head>

<body>

<table width="100%">
  <tr>
    <td valign="top">
      <h1>3D PLM Enterprise Architecture</h1>
    </td>
    <td valign="top">
      <h2>Data Access - Database</h2>
    </td>
    <td rowspan="2" align="right" valign="top">
      <h3><a name="Top"></a>Extracting a Document from the Vault Server to a
      Memory Area</h3>
      <em>Copying an existing vault document to a memory area</em></td>
  </tr>
  <tr>
    <td class="use" colspan="2">Use Case</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->

<table class="abstract">
  <tr>
    <td>
      <h3>Abstract</h3>
      <p>This article shows how to open a document in the vault server, and copy
      its contents into a memory area.
      <ul>
        <li><a href="#Learn"><strong>What You Will Learn With This Use Case</strong></a></li>
        <li><a href="#UseCase"><strong>The CAAEvcExtractDocIntoMem Use Case</strong></a>
          <ul>
            <li><a href="#What">What Does CAAEvcExtractDocIntoMem Do</a></li>
            <li><a href="#How">How to Launch CAAEvcExtractDoc</a><a href="#How">IntoMem</a></li>
            <li><a href="#Where">Where to Find the CAAEvcExtractDocIntoMem Code</a></li>
          </ul>
        <li><a href="#Step"><strong>Step-by-Step</strong></a></li>
        <li><a href="#InShort"><strong>In Short</strong></a></li>
        <li><a href="#References"><strong>References</strong></a></li>
      </ul>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="Learn"></a>What You Will Learn With This Use Case</h3>
<p>This use case is intended to show you how to retrieve a document from a vault
server and copy it to a memory area. It also shows how to open a vault session.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h3><a name="UseCase"></a>The CAAEvcExtractDocIntoMem Use Case</h3>
<p>CAAEvcExtractDocIntoMem is a use case of the CAAENOVaultClientCPP.edu
framework that illustrates ENOVaultClientCPP framework capabilities.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="What"></a>What Does CAAEvcExtractDocIntoMem Do</h4>
<p>CAAEvcExtractDocIntoMem begins by opening a vault session. Then it retrieves
a vault document from an URL taken as input and copies the contents of the
document to a memory area.
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="How"></a>How to Launch CAAEvcExtractDocIntoMem&nbsp;</h4>
<p>To launch CAAEvcExtractDocIntoMem, you will need to set up the build time
environment, then compile CAAEvcExtractDocIntoMem along with its prerequisites,
set up the run time environment, and then execute the use case as follows: [<a href="#References">3</a>].</p>
<pre>mkrun -c &quot;CAAEvcExtractDocIntoMem -u <i>DocumentURL</i>&quot;</pre>
<p>where:</p>
<ul>
  <li><code><i>DocumentURL</i></code> is the Document URL</li>
</ul>
<p>You can use as input the document URL generated by the CAAEvcCreateDocFromMem
use case [<a href="#References">1</a>] or the CAAEvcCreateDocFromFile use case [<a href="#References">2</a>].</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Where"></a>Where to Find the CAAEvcExtractDocIntoMem Code</h4>
<p>The CAAEvcExtractDocIntoMem use case is made of the single file
CAAEvcExtractDocIntoMem.cpp located in the CAAEvcExtractDocIntoMem.m module of
the CAAENOVaultClientCPP.edu framework:</p>
<table>
  <tr>
    <td>Windows</td>
    <td><code>InstallRootDirectory\CAAENOVaultClientCPP.edu\CAAEvcExtractDocIntoMem.m\</code></td>
  </tr>
  <tr>
    <td>Unix</td>
    <td><code>InstallRootDirectory/CAAENOVaultClientCPP.edu/CAAEvcExtractDocIntoMem.m/</code></td>
  </tr>
</table>
<p>where <code>InstallRootDirectory</code> is the directory where the CAA CD-ROM
is installed.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h3><a name="Step"></a>Step-by-Step</h3>
<p>There are nine logical steps in CAAEvcExtractDocIntoMem:</p>
<ol>
  <li><a href="#Step1">Creating the Vault Session</a></li>
  <li><a href="#Step2">Retrieving the Document</a></li>
  <li><a href="#Step3">Opening the Document in Read Mode</a></li>
  <li><a href="#Step4">Retrieving the Document Size</a></li>
  <li><a href="#Step5">Copying the Document into a Memory Area</a></li>
  <li><a href="#Step6">Closing the Document</a></li>
  <li><a href="#Step7">Preparing the Transaction</a></li>
  <li><a href="#Step8">Committing the Transaction</a></li>
  <li><a href="#Step9">Ending the Session</a></li>
</ol>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step1"></a>Creating the Vault Session</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   ENOVIVaultError     VErr;
   CATBoolean          Master  = TRUE;

   // As the Vault session is opened as master, the following arguments are 
   // not taken into account
   CATUnicodeString    Marker(&quot;&quot;);
   CATUnicodeString    Host(&quot;&quot;);
   int                 Port    = 0;

   ENOVIVaultSession * pSession = NULL;

   RC = <b>ENOVIVaultSessionFactory::getVaultSession</b>(Marker, Host, Port, Master, &amp;pSession, VErr);
...</pre>
    </td>
  </tr>
</table>
<p>The first thing to do is to create a vault session, thanks to the static <code>getVaultSession</code>
method of the <i>ENOVIVaultSessionFactory</i> class. The vault component
supports distributed transactions (i.e. several processes working in the context
of the same transaction) but in this case only one of the sessions is a master
one and is able to commit or rollback the transaction. As this use case is a
stand alone program, the session must necessarily be opened as master. The
useful arguments are:</p>
<ul>
  <li><code>Master</code> is set to <code>TRUE</code> to indicate a master
    session</li>
  <li><code>pSession</code> is the initialized vault session as a pointer to the
    <i>ENOVIVaultSession</i> interface</li>
  <li><code>VErr</code> is an <i>ENOVIVaultError</i> class instance passed as
    the last argument used if the method fails to convey information about the
    failure.
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step2"></a>Retrieving the Document</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   ENOVIVaultDocument * pDoc = NULL;
   pSession-&gt;<b>bindDocument</b>(s_InputUrl, &amp;pDoc, VErr); 
...</pre>
    </td>
  </tr>
</table>
<p>An URL contains all the necessary information enabling to retrieve a
document. The <code>bind</code><code>Document</code> from the <i>ENOVIVaultSession</i>
interface connects to the Vault server containing the required document and
build an <i>ENOVIVaultDocument</i> object. The parameters to pass to <code>bind</code><code>Document</code>
are:</p>
<ul>
  <li><code>s_InputUrl</code> is the URL of the document passed as a parameter
    of the command that launches the use case</li>
  <li><code>pDoc</code> is the initialized document as a pointer to the <i>ENOVIVaultDocument</i>
    interface</li>
  <li><code>VErr</code> is an <i>ENOVIVaultError</i> class instance passed as
    the last argument used if the method fails to convey information about the
    failure.</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step3"></a>Opening the Document in Read Mode</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   RC = pDoc-&gt;<b>openRead</b>(VErr);
...</pre>
    </td>
  </tr>
</table>
<p>Before any read operation, the document must be opened in read mode.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step4"></a>Retrieving the Document Size</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   unsigned long iSize = 0; 

   RC = pDoc-&gt;<b>getSize</b>(iSize, VErr); 
...</pre>
    </td>
  </tr>
</table>
<p>The <code>getSize</code> methods will enable the memory area to be
dimensioned.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step5"></a>Copying the Document into a Memory Area</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   SEQUENCE_octet Buffer;
   Buffer.length(iSize); 

   RC = pDoc-&gt;<b>read</b>(iSize, Buffer, VErr);
...</pre>
    </td>
  </tr>
</table>
<p>The document contents is now copied to Buffer variable. We could have used
the <code>readBlock</code> method as well. This method would have been specially
appropriate if the data were spread among several memory areas.</p>
<p>The parameter to pass to&nbsp;<code>read</code> are:</p>
<ul>
  <li><code>iSize</code> is the amount, in bytes, of data to read</li>
  <li><code>Buffer</code> contains the data to read</li>
  <li><code>VErr</code> is an <i>ENOVIVaultError</i> class instance passed as
    the last argument used if the method fails to convey information about the
    failure.</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step6"></a>Closing the Document</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   RC = pDoc-&gt;<b>close</b>(VErr);
...</pre>
    </td>
  </tr>
</table>
<p>The document must always be closed. Pay a special attention to the error
management. If any kind of error occurs after a document has been opened, make
sure it is closed before exiting the method in which you handle the document.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step7"></a>Preparing the Transaction</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   RC = pSession-&gt;<b>prepare</b>(VErr);
...</pre>
    </td>
  </tr>
</table>
<p>The vault is designed to cooperate with other data servers. So it supports a
two-phase commit. That means that the save operation has been split into two
steps: prepare and commit.&nbsp;This applies to all the vault documents
currently managed by all the user sessions of the vault session. When preparing
and committing the transaction, a check is performed to determine whether
documents are opened. If an opened document exists, it is considered as &quot;in
work&quot; and to ensure that no document is saved in an inconsistent state, the
whole save operation is aborted.&nbsp;</p>
<p>When preparing the transaction, all the necessary checks and most of the save
operations are performed, the objective being to make sure that nothing will
prevent from committing.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step8"></a>Committing the Transaction</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   RC = pSession-&gt;<b>commit</b>(VErr);
...</pre>
    </td>
  </tr>
</table>
<p>Committing the transaction is a very light operation validating what has been
done when preparing the transaction.&nbsp;Once committed, all the modifications
done since the previous commit are saved and become visible to the other users.</p>
<p>As no document has been modified or created in this use case, it would be
equivalent to use the rollback or abort methods of the <i>ENOVIVaultSession</i>
interface.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="Step9"></a>Ending the Session</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
   RC = <b>ENOVIVaultSessionFactory::endVaultSession</b>(pSession, VErr);
...</pre>
    </td>
  </tr>
</table>
<p>This ends and closes the vault session.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<!---------------------------------comment------------------------------------->
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="InShort"></a>In Short</h3>
<p>This use case has demonstrated how to initialize the vault environment,
retrieve a vault document and copy it into a memory area.</p>
<ul>
  <li>The vault environment is initialized by creating a vault session using the
    <code>ENOVIVaultSessionFactory::getVaultSession</code> static method that
    returns a pointer to the <i>ENOVIVaultSession</i> interface</li>
  <li>This pointer is used in turn to retrieve a vault document using the <code>bindDocument</code>
    method of <i>ENOVIVaultSession</i>. This document is handled as a pointer to
    the <i>ENOVIVaultDocument</i> interface.</li>
  <li>Then the vault document is opened in read mode, its size is retrieved, its
    content is copied to a memory area, and it is closed using the <code>openRead</code>,
    <code>getSize</code>, <code>read</code>, and <code>close</code> methods of <i>ENOVIVaultDocument</i>
    respectively</li>
  <li>The transaction is then closed thanks to the <code>prepare</code> and <code>commit</code>
    methods of the <i>ENOVIVaultSession</i> interface</li>
  <li>Finally, the vault session is closed using the <code>ENOVIVaultSessionFactory::endVaultSession</code>
    static method of the <i>ENOVIVaultSession</i> interface.</li>
</ul>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="References"></a>References</h3>
<table width="100%">
  <tr>
    <td valign="top">[1]</td>
    <td><a href="CAAEvcCreateDocFromMem.htm">Creating a Document from a Memory
      Area in the Vault Server</a></td>
  </tr>
  <tr>
    <td valign="top">[2]</td>
    <td><a href="CAAEvcCreateDocFromFile.htm">Creating a Document from a File in
      the Vault Server</a></td>
  </tr>
  <tr>
    <td valign="top">[3]</td>
    <td><a href="../CAADocUseCases/CAADocRunSample.htm">Building
      and Launching a CAA V5 Use Case</a></td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="History"></a>History</h3>
<table width="100%">
  <tr>
    <td valign="top">Version: <strong>1</strong> [Sep 2001]</td>
    <td valign="top">Document created</td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<p><i>Copyright © 2001, Dassault Systèmes. All rights reserved.</i></p>

</body>

</html>
