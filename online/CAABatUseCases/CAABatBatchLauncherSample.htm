<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 6.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="Stylesheet" type="text/css" href="../CAADocStyleSheets/caav5.css">
<title>Launching CAA V5 Batch</title>
<style>
<!--
 li.MsoNormal
	{mso-style-parent:"";
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:"Times New Roman";
	margin-left:0in; margin-right:0in; margin-top:0in}
span.SpellE
	{}
span.GramE
	{}
-->
</style>
</head>

<body>

<table width="100%">
  <tr>
    <td valign="top">
      <h1>Middleware</h1>
    </td>
    <td valign="top">
      <h2>BatchInfrastructure</h2>
    </td>
    <td rowspan="2" align="right" valign="top">
      <h3><a name="Top"></a>Launching CAA V5 Batch</h3>
      <em>Launching a CAA V5 Batch from a code source.</em></td>
  </tr>
  <tr>
    <td class="use" colspan="2">Use Case</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->

<table class="abstract">
  <tr>
    <td>
      <h3>Abstract</h3>
      <p>This article shows how to launch a CAA V5 Batch from a code source.
      <ul>
        <li><a href="#Learn"><strong>What You Will Learn With This Use Case</strong></a></li>
        <li><a href="#UseCase"><strong>The CAABatBatchLauncherSample Use Case</strong></a>
          <ul>
            <li><a href="#What">What Does CAABatBatchLauncherSample Do</a></li>
            <li><a href="#How">How to Launch CAABatBatchLauncherSample</a></li>
            <li><a href="#Where">Where to Find the CAABatBatchLauncherSample Code</a></li>
          </ul>
        <li><a href="#Step"><strong>Step-by-Step</strong></a></li>
		<li><a href="#InShort"><strong>In Short</strong></a></li>
		<li><a href="#References"><strong>References</strong></a></li>
      </ul>
      <tr>
    <td>
      &nbsp;</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="Learn"></a>What You Will Learn With This Use Case</h3>
<p>This use case is intended to show you how to launch CAA V5 Batch in a code 
source, using the Batch APIs.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h3><a name="UseCase"></a>The CAABatBatchLauncherSample Use Case</h3>
<p>CAABatBatchLauncherSample is a use case of the CAABatBatchInfrastructure.edu framework that illustrates 
Batch infrastructure capabilities.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="What"></a>What Does CAABatBatchLauncherSample Do</h4>
<p>The CAABatBatchLauncherSample 's purpose is to show how to launch and monitor 
a CAA V5 Batch. The example batch takes as input&nbsp; a list of .model files 
and renames them to .CATPart files. </p>
<p>To do this, the use case will show how to :</p>
<p>&nbsp;&nbsp;&nbsp; - generate a XML describing the input files.</p>
<p>&nbsp;&nbsp;&nbsp; - use callback to be notified of the end of the batch 
replay</p>
<p>&nbsp;&nbsp;&nbsp; - analyze the generated XML file describing the outputs.</p>
<p>
<br>
<b><u>Warning</u></b>: this batch sample does not convert model files to CATPart files. It is 
only about renaming the files.<br>
&nbsp;</p>
<p>[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->
<h4><a name="How"></a>How to Launch CAABatBatchLauncherSample</h4>
<p>To launch CAABatBatchLauncherSample , you will need to set up the build time 
environment ,then compile CAABatBatchLauncherSample along with its 
prerequisites, set up the run time environment :</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;&nbsp;&nbsp;&nbsp; 
set ADL_ODT_IN variable to the directory where the input files to rename are 
located :</p>
<table id="table8">
	<tr>
		<td width="58">Windows</td>
		<td><font face="Courier">
		InstallRootDirectory\CAABatchInfrastructure.edu\Data.d\</font></td>
	</tr>
	<tr>
		<td width="58">Unix</td>
		<td><font face="Courier">
		InstallRootDirectory/CAABatchInfrastructure.edu/Data.d/</font></td>
	</tr>
</table>
<p><font size="2"><span style="font-family: Arial">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
-&nbsp;&nbsp;&nbsp; set BATCH_HOME to a writable directory where all the 
renamed files will be copied.</span></font></p>
<p>&nbsp;and then execute the use case :</p>
<p><font size="2"><span style="font-family: Arial">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
-&nbsp;&nbsp;&nbsp;&nbsp; launch the start command mkrun -c&nbsp; </span></font>
<span style="font-size: 10.0pt; font-family: Arial">CAABatBatchLauncherSample</span></p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Where"></a>Where to Find the CAABatBatchLauncherSample Code</h4>
<p>The CAABatBatchLauncherSample use case is made of a single function named 
batchmain located in the CAABatBatchLauncherSample.m module of the 
CAABatchInfrastructure.edu framework:</p>
<table id="table1">
	<tr>
		<td width="58">Windows</td>
		<td><font face="Courier">
		InstallRootDirectory\CAABatchInfrastructure.edu\ 
		CAABatBatchLauncherSample.m\</font></td>
	</tr>
	<tr>
		<td width="58">Unix</td>
		<td><font face="Courier">
		InstallRootDirectory/CAABatchInfrastructure.edu/ 
		CAABatBatchLauncherSample.m/</font></td>
	</tr>
</table>
<p>where <code>InstallRootDirectory</code> is the directory where the CAA CD-ROM 
is installed.</p>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h3><a name="Step"></a>Step-by-Step</h3>
<p>There are seven logical steps in CAABatBatchLauncherSample:</p>
<ol>
  <li><a href="#Step1">Generating the XML input</a></li>
  <li><a href="#Step2">Retrieving the CATBatClientMonitorCAA interface</a></li>
  <li><a href="#Step3">Initialization of the CATBatClientMonitorCAA</a></li>
  <li><a href="#Step4">Initialization of callbacks</a></li>
  <li><a href="#Step5">Starting the CAA V5 Batch</a></li>
  <li><a href="#Step6">Analyzing output files and result check</a></li>
  <li><a href="#Step7">Cleaning up</a></li>
</ol>
<p align="right">[<a href="#Top">Top</a>]</p>
<!---------------------------------comment------------------------------------->

<h4><a name="Step1"></a>Generating the input XML input</h4>
<table class="code">
  <tr>
    <td>
      <pre>...
CATBatchParameters input_param;
input_param.BeginBuffer(&quot;BatchSample&quot;, &quot;ParamTest.xml&quot;); 

input_param.BeginInput();
input_param.InsertFile(&quot;file1&quot;, &quot;CAABatchInfrastructure.edu\\Data.d\\ATTRIBUTCXR1.model&quot;, &quot;&quot;, COMM_FILE_BINARY);
input_param.InsertFile(&quot;file2&quot;, &quot;CAABatchInfrastructure.edu\\Data.d\\BOBINE.model&quot;, &quot;&quot;, COMM_FILE_BINARY);
input_param.InsertFile(&quot;file3&quot;, &quot;CAABatchInfrastructure.edu\\Data.d\\CUBE.model&quot;, &quot;&quot;, COMM_FILE_BINARY);

input_param.InsertSimpleArg(&quot;action&quot;, &quot;1&quot;);
input_param.EndInput();

const char* out_folder = &quot;&quot;; </pre>
		<pre>
input_param.BeginOutput();
input_param.InsertFolder(&quot;out_dir&quot;, out_folder, &quot;&quot; , COMM_FILE_BINARY, &quot;CATPart&quot;);
input_param.EndOutput();
input_param.EndBuffer();

...</pre>
    </td>
  </tr>
</table>
<p>To launch a CAA V5 Batch, an XML input file must be defined. The first part 
of the sample aims at generating that XML file, which is not provided as input 
data in this sample.</p>
<p>This XML file contains :</p>
<ul style="MARGIN-TOP: 0in; MARGIN-BOTTOM: 0in" type="disc">
	<ul style="MARGIN-TOP: 0in; MARGIN-BOTTOM: 0in" type="circle">
		<li><i>BatchSample</i> is the name of the descriptor file. </li>
		<li><i>ParamTest.xml</i> is the name of the parameter file<span style="font-weight: normal; font-size: 7pt; color: #333333; font-style: normal; font-family: Verdana; font-variant: normal"> 
		.</span> </li>
		<li>XXX\ATTRIBUTCXR1.model&#8221; is the full path of the input file<O:P>s.</O:P>
		</li>
		<li><i>out_folder</i> &nbsp;attribute is the full path for the output 
		directory. If this attribute is set to &#8220;&#8221;, such as in the example, the 
		directory defined with the BATCH_HOME variable is used. </li>
		<li><i>BeginInput</i>() and <i>EndInput</i>() are used at the beginning 
		and the end of the input data section. </li>
		<li><i>BeginOutput</i>() and <i>EndOutput</i>() methods are used at the 
		beginning and the end of output data section. </li>
	</ul>
</ul>
<p>The Parameters.dtd file used to check the xml files syntax is provided by the 
Batch Infrastructure and is used for all batches.</p>
<p>More details about the parameter file can be 
found in the use case &quot;Creating a CAA V5 Batch&quot;.[<a href="#References">1</a>]</p>
<p align="right">[<a href="#Top">Top</a>]</p>

<!---------------------------------comment------------------------------------->

<h4><a name="Step2"></a><a href="#Step2">Retrieving the CATBatClientMonitorCAA interface</a></h4>
<table class="code">
  <tr>
    <td>
      <pre>...
	CATBatClientMonitorCAA* cliMonitor = CATBatClientMonitorCAA::GetTheClientMonitorCAA();</pre>
		<pre>...</pre>
    </td>
  </tr>
</table>
<p>The method&nbsp; <i>GetTheClientMonitorCAA</i> returns a pointer to the interface 
CATBatClientMonitorCAA. </p>

<h4>&nbsp;</h4>
<h4><a name="Step3"></a><a href="#Step3">Initialization of the CATBatClientMonitorCAA</a></h4>
<table class="code" id="table2">
  <tr>
    <td>
      <pre>...
	HRESULT hr = cliMonitor-&gt;InitializeV5Monitoring();
...</pre>
    </td>
  </tr>
</table>
<p>The method <i>InitializeV5Monitoring</i> initializes the ability of monitoring CAA V5 
Batchs.</p>
<p>&nbsp;</p>

<h4><a name="Step4"></a><a href="#Step4">Initialization of callbacks</a></h4>
<table class="code" id="table3">
  <tr>
    <td>
      <pre>...
	CATBatchEventWatcher evt(&amp;cond_for_exit);
...</pre>
    </td>
  </tr>
</table>
<p>A specific object to register callbacks on batch events must be created : 
CATBatchEventWatcher. In this example, the only event we're looking for is the 
CATBatchEndNotif. (end of the batch execution) When the batch replay is 
finished, the main can check the result of the&nbsp; file renaming.</p>
<p>The initialization of the call is done with the AddCallback method that 
is called by the constructor of the&nbsp; CATBatchEventWatcher class.</p>
<p>The CATBatchEventWatcher&nbsp; class is defined in an other source of this 
sample (CATBatchEventWatcher.h and CATBatchEventWatcher.cpp). It contains the 
call back definition and the notification emission when the batch replay is 
finished.</p>
<p>&nbsp;</p>
<h4><a name="Step5"></a><a href="#Step5">Starting the CAA V5 Batch</a></h4>
<table class="code" id="table4">
  <tr>
    <td>
      <pre>...
	CATUnicodeString path_param;
	input_param.GetFullPath(path_param);

	hr = cliMonitor-&gt;StartV5Batch(path_param, uuid); 

	evt.SetUUID(uuid);
...</pre>
    </td>
  </tr>
</table>
<p>The method <i>GetFullPath </i>retrieves the full path of the previously 
generated XML parameter file.</p>
<p><i>SetUUID</i> is called after we start the CAA V5 Batch because we need to know the 
batch identifier, uuid, which is an output argument retrieved by a call to the
<i>StartV5Batch </i>method<i>. </i>It is a unique identifier that identifies the 
running batch. It is used as an input argument to get information about the 
batch execution. In this example, it is used in the <i>SetUUID</i> method to 
tell the CATBatchEventWatcher which CATBatchEventNotif it must expect.</p>
<p>At the end of the batch replay, a notification is received by the CATBatchEventWatcher 
(the callback was initialized in the previous step). The UUID is used to check 
which batch is ending, and avoids confusion if there are several bachs running 
at the same time.</p>
<h4>&nbsp;</h4>
<h4><a name="Step6"></a><a href="#Step6">Analyzing output files and result check</a> </h4>
<h4>&nbsp;</h4>
<table class="code" id="table7">
  <tr>
    <td>
      <pre>...</pre>
		<pre>	CATIBatchCAA* outputParamfile =NULL;
 	if (rc==0)
	{
		hr = GetOutputXMLFile(outputParamfile, uuid);


		CATIBatchElementCAA* outputParametersSection = NULL;

		hr = outputParamfile-&gt;get_OutputParametersCAA(outputParametersSection);

		CATIBatchElementsCAA* fileList=NULL;
		hr = outputParametersSection-&gt;get_FileListCAA(fileList);
	
		CATIBatchElementCAA* elem = NULL;
		long fileCount = 0;
		hr = fileList-&gt;get_Count(fileCount);
	
		CATUnicodeString path;
		for ( int ii = 0; ii&lt;fileCount; ii++ )
		{
			hr = fileList-&gt;ItemCAA( ii, elem );
			elem-&gt;get_Path(path);
	
			printf(&quot;Found output &lt;%s&gt;\n&quot;, path.CastToCharPtr());
		}

	}</pre>
		<pre>...</pre>
      <pre>&nbsp;</pre>
    </td>
  </tr>
</table>
<p>The batch has ended. The Return Code is 0, so the batch ended with success. 
We now open the generated output file to analyze its content. We retrieve the 
generated file thanks to the batch uuid, its unique identifier. </p>
<p>We create an access to the CATIBatchCAA&nbsp; interface to call the methods 
that will allow us to retrieves all the parameters of the output file. The list 
of rename file is retrieved, the number of item counted. In this example, the 
complete paths of renamed files are read with the <i>get_Path</i> method and 
printed on the standard output so that the end user can check the sample has 
done its work correctly.</p>
<p>To check if the sample has done its work correctly, open the $BATCH_HOME 
directory and check there are the 3 renamed files :<br>
ATTRIBUTCXR1.CATPart, CUBE.CATPart and BOBINE.CATPart.</p>
<h4><a name="Step7"></a>Cleaning up</h4>
<table class="code" id="table6">
  <tr>
    <td>
      <pre>CATDeleteFile(path_param.CastToCharPtr());

CATBatchLogCAA::DeleteLogs(uuid);</pre>
    </td>
  </tr>
</table>
<p>Before leaving, we do some clean up.</p>
<p><i>CATDeleteFile</i> deletes the input parameter file. The method <i>DeleteLogs</i> from 
the CATBatchLogCAA interface cleans the batch log files. </p>
<p align="right">[<a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="InShort"></a>In Short</h3>
<p>A CAA V5 batch can be launched in source code using APIs provided by the 
CATBatClientMonitorCAA interface.<p align="right"><i>[</i><a href="#Top">Top</a>]</p>
<hr>
<!---------------------------------comment------------------------------------->

<h3><a name="References"></a>References</h3>
<table width="100%">
  <tr>
    <td valign="top" width="2%">[1]</td>
    <td width="97%"><a href="CAABatBatchSample.htm">Creating a CAA V5 Batch</a></td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<h3><a name="History"></a>History</h3>
<table width="100%">
  <tr>
    <td valign="top">Version: <strong>1</strong> [Jan 2007]</td>
    <td valign="top">Document created</td>
  </tr>
  <tr>
    <td valign="top" align="right" colspan="2">[<a href="#Top">Top</a>]</td>
  </tr>
</table>
<hr>
<!---------------------------------comment------------------------------------->
<p><i>Copyright © 1994-2005, Dassault Systèmes. All rights reserved.</i></p>

</body>

</html>
